function readfile(){var e=document.getElementById("files").files[0],o=new FileReader;o.readAsText(e),o.onloadend=(()=>{if(r=o.result,-1!=savewithxml().indexOf("</block>"))if(confirm("检测到工作区已有积木,是否覆盖?"))loadwithxml(r);else{if(!confirm("是否需要在原先基础上添加积木?"))return;Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(r),wks)}else loadwithxml(r)})}$("#app").hide(),copy=(e=>{var o=document.createElement("textarea");o.value=e,document.body.appendChild(o),o.select(),document.execCommand("Copy"),o.style.display="none"}),loadwithxml=(e=>{wks.clear(),Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(e),wks)}),savewithxml=(()=>Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(wks))),savetoserver=(()=>{$("#save").attr("class","fa fa-refresh fa-spin"),-1==savewithxml().indexOf("</block>")&&$("#save").attr("class","fa fa-cloud-upload"),$.post("/xmlset/"+window.wkstk,{xml:savewithxml()},()=>{setTimeout(()=>{$("#save").attr("class","fa fa-cloud-upload")},1e3)})}),tocode=(()=>{if("ty"==window.wksname)return alert("体验模式不可以生成代码");Blockly.JavaScript.workspaceToCode(wks);try{code=(window.usjs?window.sjscode:"")+Blockly.JavaScript.workspaceToCode(wks),copy(code),alert("代码已复制")}catch(e){alert("生成失败:\n"+e)}}),loadfromserver=(()=>{$.post("/xmlget/"+window.wkstk,e=>{vars.CODEXML=e,loadwithxml(e)})}),vars={CODEXML:""},local=!1,loadfromfile=(e=>{loadwithxml(e)}),$(document).ready(()=>{$("#app").fadeIn(1e3),con={toolbox:document.getElementById("tbx"),media:"/static/media/",grid:{spacing:25,length:4,colour:"#ccc",snap:!0},zoom:{controls:!0,wheel:!0}},"ty"==window.wksname&&(con.maxBlocks=10),"_"==window.wkstk&&(con.grid={}),wks=Blockly.inject("main",con),loadfromserver(),wks.setTheme(window.Box3Theme),setInterval(savetoserver,6e4),$.post("/static/text/sjs.min.js",e=>{window.sjscode=e}),$(".injectionDiv #app").css("z-index","-1"),$(".bg1").css("z-index","-999")}),$(()=>{$("#savelink").click(savetoserver),$("#reflink").click(loadfromserver),$("#tocodelink").click(tocode),$("#downloadlink").click(()=>{saveString("work.xml",savewithxml())}),$("#files").change(readfile)}),$("#music-player").click(()=>{var e=new Audio("/static/media/mus.mp3");e.play(),e.onended=function(){this.play()},$("#music-player").remove()});